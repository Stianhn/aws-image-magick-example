FROM amazoncorretto:17.0.7-al2023 AS builder

RUN dnf update -y && \
    dnf groupinstall -y "Development Tools" && \
    dnf install -y \
        wget \
        pkg-config \
        libjpeg-devel \
        libpng-devel \
        zlib-devel \
        libtool \
        autoconf \
        automake \
        cmake \
        git \
        tar \
        make \
        gcc \
        gcc-c++ \
        flex \
        bison

ENV PREFIX=/usr/local
ENV PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig"

RUN cd /tmp && \
    wget https://download.gnome.org/sources/libxml2/2.10/libxml2-2.10.3.tar.xz && \
    tar xvJf libxml2-2.10.3.tar.xz && \
    cd libxml2-2.10.3 && \
    ./configure --prefix=${PREFIX} --enable-static --disable-shared --with-pic --without-python && \
    make -j$(nproc) && \
    make install

RUN cd /tmp && \
    git clone https://github.com/strukturag/libde265.git && \
    cd libde265 && \
    ./autogen.sh && \
    CFLAGS="-fPIC" ./configure --enable-static --disable-shared --with-pic --prefix=${PREFIX} && \
    make -j$(nproc) && \
    make install

RUN cd /tmp && \
    git clone https://github.com/strukturag/libheif.git && \
    cd libheif && \
    mkdir build && cd build && \
    cmake .. \
        -DBUILD_SHARED_LIBS=OFF \
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
        -DCMAKE_INSTALL_PREFIX=${PREFIX} \
        -DCMAKE_INSTALL_LIBDIR=lib \
        -DWITH_LIBDE265=ON \
        -DLIBDE265_INCLUDE_DIR=${PREFIX}/include \
        -DLIBDE265_LIBRARY=${PREFIX}/lib/libde265.a && \
    make -j$(nproc) && \
    make install && \
    sed -i 's/^Libs:/& -lde265/' ${PREFIX}/lib/pkgconfig/libheif.pc

RUN cd /tmp && \
    wget https://www.imagemagick.org/download/ImageMagick.tar.gz && \
    tar xvzf ImageMagick.tar.gz && \
    cd ImageMagick-* && \
    ./configure \
        --prefix=${PREFIX} \
        --with-heic=yes \
        --with-xml=yes \
        --with-tiff=no \
        --with-webp=no \
        --with-jpeg=yes \
        --with-png=no \
        --disable-shared \
        --enable-static \
        CPPFLAGS="-I${PREFIX}/include" \
        LDFLAGS="-L${PREFIX}/lib" \
        LIBS="-lde265 -lxml2" && \
    make -j$(nproc) && \
    make install && \
    cd ${PREFIX} && \
    tar czvf /tmp/imagemagick.tar.gz *

# Run container to grab export and/or verify install
FROM alpine AS export
COPY --from=builder /tmp/imagemagick.tar.gz /imagemagick.tar.gz
CMD ["sleep", "infinity"]


# To get tar run
# docker buildx build --platform linux/amd64 -t imagemagick-builder .
# docker create --name extract imagemagick-builder
# docker cp extract:/imagemagick.tar.gz .
# docker rm extract
